{% extends "base.html" %}

{% block title %}Proposer un livre - BiblioRuche{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <!-- Recherche par ISBN -->
        <div class="card mb-4">            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-search"></i> Recherche automatique par ISBN ou titre</h5>
            </div><div class="card-body">
                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label for="search-input" class="form-label">Recherche de livre</label>
                        <input type="text" id="search-input" class="form-control" placeholder="Entrez l'ISBN (ex: 9782070360024) ou le titre du livre">
                        <small class="text-muted">Saisissez l'ISBN à 10 ou 13 chiffres ou le titre du livre pour rechercher automatiquement les informations</small>
                    </div>                    <div class="col-md-4 mb-3">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" id="search-btn" class="btn btn-primary w-100">
                            <i class="fas fa-search"></i> Rechercher
                        </button>
                    </div>
                </div>
                <div id="search-result" class="mt-3" style="display: none;">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> Livre trouvé ! Les informations ont été remplies automatiquement dans le formulaire ci-dessous.
                    </div>
                </div>                <div id="search-error" class="mt-3" style="display: none;">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> Aucun livre trouvé pour cette recherche. Vous pouvez remplir le formulaire manuellement ci-dessous.
                    </div>
                </div>
                <div id="search-loading" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-spinner fa-spin"></i> Recherche en cours...
                    </div>
                </div>
            </div>
        </div>

        <!-- Séparateur -->
        <div class="text-center mb-4">
            <span class="badge bg-secondary px-4 py-2">OU</span>
        </div>

        <!-- Formulaire manuel -->
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-edit"></i> Saisie manuelle</h4>
            </div>
            <div class="card-body">
                <form method="POST">
                    {{ form.hidden_tag() }}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.title.label(class="form-label") }}
                            {{ form.title(class="form-control") }}
                            {% if form.title.errors %}
                                <div class="text-danger">
                                    {% for error in form.title.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            {{ form.author.label(class="form-label") }}
                            {{ form.author(class="form-control") }}
                            {% if form.author.errors %}
                                <div class="text-danger">
                                    {% for error in form.author.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.description.label(class="form-label") }}
                        {{ form.description(class="form-control", rows="4") }}
                        {% if form.description.errors %}
                            <div class="text-danger">
                                {% for error in form.description.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="text-muted">Décrivez brièvement le livre et pourquoi vous le recommandez.</small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            {{ form.isbn.label(class="form-label") }}
                            {{ form.isbn(class="form-control") }}
                            {% if form.isbn.errors %}
                                <div class="text-danger">
                                    {% for error in form.isbn.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            {{ form.publisher.label(class="form-label") }}
                            {{ form.publisher(class="form-control") }}
                            {% if form.publisher.errors %}
                                <div class="text-danger">
                                    {% for error in form.publisher.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            {{ form.publication_year.label(class="form-label") }}
                            {{ form.publication_year(class="form-control") }}
                            {% if form.publication_year.errors %}
                                <div class="text-danger">
                                    {% for error in form.publication_year.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                      <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.pages_count.label(class="form-label") }}
                            {{ form.pages_count(class="form-control") }}
                            {% if form.pages_count.errors %}
                                <div class="text-danger">
                                    {% for error in form.pages_count.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.genre.label(class="form-label") }}
                            {{ form.genre(class="form-control") }}
                            {% if form.genre.errors %}
                                <div class="text-danger">
                                    {% for error in form.genre.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Retour
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-paper-plane"></i> Proposer ce livre
                        </button>
                    </div>
                </form>
            </div>
        </div>    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');
    const searchResult = document.getElementById('search-result');
    const searchError = document.getElementById('search-error');
    const searchLoading = document.getElementById('search-loading');    // Fonction pour nettoyer l'ISBN
    function cleanISBN(isbn) {
        return isbn.replace(/[^0-9X]/g, '');
    }

    // Fonction pour détecter si c'est un ISBN
    function isISBN(query) {
        const cleaned = cleanISBN(query);
        return cleaned.length >= 10 && /^[0-9X]+$/.test(cleaned);
    }

    // Fonction pour rechercher un livre par ISBN ou titre
    async function searchBook(query) {
        try {
            let apiUrl;
            
            if (isISBN(query)) {
                const cleanedISBN = cleanISBN(query);
                apiUrl = `https://www.googleapis.com/books/v1/volumes?q=isbn:${cleanedISBN}&langRestrict=fr`;
            } else {
                const encodedTitle = encodeURIComponent(query);
                apiUrl = `https://www.googleapis.com/books/v1/volumes?q=intitle:${encodedTitle}&langRestrict=fr&orderBy=relevance`;
            }
            
            const response = await fetch(apiUrl);
            
            if (!response.ok) {
                throw new Error('Erreur de connexion à l\'API Google Books');
            }
            
            const data = await response.json();

            if (!data.items || data.totalItems === 0) {
                throw new Error('Aucun livre trouvé pour cette recherche');
            }

            return data.items[0].volumeInfo;
        } catch (error) {
            console.error('Erreur lors de la recherche:', error);
            throw error;
        }
    }

    // Fonction pour remplir le formulaire
    function fillForm(bookInfo) {
        // Titre
        if (bookInfo.title) {
            document.getElementById('title').value = bookInfo.title;
        }

        // Auteur(s)
        if (bookInfo.authors && bookInfo.authors.length > 0) {
            document.getElementById('author').value = bookInfo.authors.join(', ');
        }

        // Description
        if (bookInfo.description) {
            document.getElementById('description').value = bookInfo.description;
        }

        // Éditeur
        if (bookInfo.publisher) {
            document.getElementById('publisher').value = bookInfo.publisher;
        }

        // Année de publication
        if (bookInfo.publishedDate) {
            const year = bookInfo.publishedDate.split('-')[0];
            document.getElementById('publication_year').value = year;
        }

        // Nombre de pages
        if (bookInfo.pageCount) {
            document.getElementById('pages_count').value = bookInfo.pageCount;
        }

        // Catégories/Genre
        if (bookInfo.categories && bookInfo.categories.length > 0) {
            document.getElementById('genre').value = bookInfo.categories[0];
        }

        // ISBN
        if (bookInfo.industryIdentifiers) {
            const isbn13 = bookInfo.industryIdentifiers.find(id => id.type === 'ISBN_13');
            const isbn10 = bookInfo.industryIdentifiers.find(id => id.type === 'ISBN_10');
            const isbn = isbn13 ? isbn13.identifier : (isbn10 ? isbn10.identifier : '');
            if (isbn) {
                document.getElementById('isbn').value = isbn;
            }
        }
    }    // Gestionnaire de clic sur le bouton de recherche
    searchBtn.addEventListener('click', async function() {
        const query = searchInput.value.trim();
        
        if (!query) {
            alert('Veuillez saisir un ISBN ou un titre de livre');
            return;
        }

        // Masquer les messages précédents
        searchResult.style.display = 'none';
        searchError.style.display = 'none';
        searchLoading.style.display = 'block';

        try {
            const bookInfo = await searchBook(query);
            fillForm(bookInfo);
            searchLoading.style.display = 'none';
            searchResult.style.display = 'block';
        } catch (error) {
            searchLoading.style.display = 'none';
            searchError.style.display = 'block';
        }
    });

    // Permettre la recherche en appuyant sur Entrée
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            searchBtn.click();
        }
    });
});
</script>

{% endblock %}
