{% extends "base.html" %}

{% block title %}Proposer un livre - BiblioRuche{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <!-- Recherche par ISBN -->
        <div class="card mb-4">            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-search"></i> Recherche automatique par ISBN ou titre</h5>
            </div><div class="card-body">
                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label for="search-input" class="form-label">Recherche de livre</label>
                        <div class="autocomplete-container">
                            <input type="text" id="search-input" class="form-control" 
                                   placeholder="Entrez l'ISBN (ex: 9782070360024) ou le titre du livre"
                                   autocomplete="off">
                            <div id="autocomplete-results" class="autocomplete-results"></div>
                        </div>
                        <small class="text-muted">Saisissez l'ISBN à 10 ou 13 chiffres ou commencez à taper le titre pour voir des suggestions</small>
                    </div>                    <div class="col-md-4 mb-3">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" id="search-btn" class="btn btn-primary w-100">
                            <i class="fas fa-search"></i> Rechercher
                        </button>
                    </div>
                </div>
                <div id="search-result" class="mt-3" style="display: none;">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> Livre trouvé ! Les informations ont été remplies automatiquement dans le formulaire ci-dessous.
                    </div>
                </div>                <div id="search-error" class="mt-3" style="display: none;">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> Aucun livre trouvé pour cette recherche. Vous pouvez remplir le formulaire manuellement ci-dessous.
                    </div>
                </div>
                <div id="search-loading" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-spinner fa-spin"></i> Recherche en cours...
                    </div>
                </div>
            </div>
        </div>

        <!-- Séparateur -->
        <div class="text-center mb-4">
            <span class="badge bg-secondary px-4 py-2">OU</span>
        </div>

        <!-- Formulaire manuel -->
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-edit"></i> Saisie manuelle</h4>
            </div>
            <div class="card-body">
                <form method="POST">
                    {{ form.hidden_tag() }}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.title.label(class="form-label") }}
                            {{ form.title(class="form-control") }}
                            {% if form.title.errors %}
                                <div class="text-danger">
                                    {% for error in form.title.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            {{ form.author.label(class="form-label") }}
                            {{ form.author(class="form-control") }}
                            {% if form.author.errors %}
                                <div class="text-danger">
                                    {% for error in form.author.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.description.label(class="form-label") }}
                        {{ form.description(class="form-control", rows="4", maxlength="1000") }}
                        {% if form.description.errors %}
                            <div class="text-danger">
                                {% for error in form.description.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="text-muted">Décrivez brièvement le livre et pourquoi vous le recommandez. <span id="desc-counter">0</span>/1000 caractères</small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            {{ form.isbn.label(class="form-label") }}
                            {{ form.isbn(class="form-control") }}
                            {% if form.isbn.errors %}
                                <div class="text-danger">
                                    {% for error in form.isbn.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            {{ form.publisher.label(class="form-label") }}
                            {{ form.publisher(class="form-control") }}
                            {% if form.publisher.errors %}
                                <div class="text-danger">
                                    {% for error in form.publisher.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            {{ form.publication_year.label(class="form-label") }}
                            {{ form.publication_year(class="form-control") }}
                            {% if form.publication_year.errors %}
                                <div class="text-danger">
                                    {% for error in form.publication_year.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                      <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.pages_count.label(class="form-label") }}
                            {{ form.pages_count(class="form-control") }}
                            {% if form.pages_count.errors %}
                                <div class="text-danger">
                                    {% for error in form.pages_count.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.genre.label(class="form-label") }}
                            {{ form.genre(class="form-control") }}
                            {% if form.genre.errors %}
                                <div class="text-danger">
                                    {% for error in form.genre.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Retour
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-paper-plane"></i> Proposer ce livre
                        </button>
                    </div>
                </form>
            </div>
        </div>    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');
    const searchResult = document.getElementById('search-result');
    const searchError = document.getElementById('search-error');
    const searchLoading = document.getElementById('search-loading');
    const autocompleteResults = document.getElementById('autocomplete-results');
    
    let autocompleteTimeout = null;
    let currentFocus = -1;

    // Fonction pour nettoyer l'ISBN
    function cleanISBN(isbn) {
        return isbn.replace(/[^0-9X]/g, '');
    }

    // Fonction pour détecter si c'est un ISBN
    function isISBN(query) {
        const cleaned = cleanISBN(query);
        return cleaned.length >= 10 && /^[0-9X]+$/.test(cleaned);
    }
    
    // Auto-complétion avec notre API Open Library
    async function fetchAutocomplete(query) {
        try {
            const response = await fetch(`/api/books/autocomplete?q=${encodeURIComponent(query)}&limit=5`);
            const data = await response.json();
            return data.success ? data.suggestions : [];
        } catch (error) {
            console.error('Autocomplete error:', error);
            return [];
        }
    }
    
    // Afficher les résultats d'auto-complétion
    function showAutocomplete(suggestions) {
        if (suggestions.length === 0) {
            autocompleteResults.classList.remove('show');
            return;
        }
        
        autocompleteResults.innerHTML = suggestions.map((s, i) => `
            <div class="autocomplete-item" data-index="${i}" 
                 data-title="${s.title}" data-author="${s.author}" data-year="${s.year || ''}">
                ${s.cover_url ? `<img src="${s.cover_url}" class="autocomplete-cover" alt="">` : ''}
                <div>
                    <div class="book-title">${s.title}</div>
                    <div class="book-author">${s.author}</div>
                    ${s.year ? `<div class="book-year">${s.year}</div>` : ''}
                </div>
            </div>
        `).join('');
        
        autocompleteResults.classList.add('show');
        
        // Ajouter les événements de clic
        autocompleteResults.querySelectorAll('.autocomplete-item').forEach(item => {
            item.addEventListener('click', function() {
                const title = this.dataset.title;
                const author = this.dataset.author;
                const year = this.dataset.year;
                
                document.getElementById('title').value = title;
                document.getElementById('author').value = author;
                if (year) document.getElementById('publication_year').value = year;
                
                searchInput.value = title;
                autocompleteResults.classList.remove('show');
                
                // Optionnel: lancer une recherche complète pour avoir plus d'infos
                searchBtn.click();
            });
        });
    }
    
    // Événement de saisie pour l'auto-complétion
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        clearTimeout(autocompleteTimeout);
        
        if (query.length < 3 || isISBN(query)) {
            autocompleteResults.classList.remove('show');
            return;
        }
        
        // Débounce de 300ms
        autocompleteTimeout = setTimeout(async () => {
            const suggestions = await fetchAutocomplete(query);
            showAutocomplete(suggestions);
        }, 300);
    });
    
    // Navigation clavier dans l'auto-complétion
    searchInput.addEventListener('keydown', function(e) {
        const items = autocompleteResults.querySelectorAll('.autocomplete-item');
        
        if (e.key === 'ArrowDown') {
            currentFocus++;
            setActive(items);
            e.preventDefault();
        } else if (e.key === 'ArrowUp') {
            currentFocus--;
            setActive(items);
            e.preventDefault();
        } else if (e.key === 'Enter' && currentFocus > -1) {
            e.preventDefault();
            if (items[currentFocus]) items[currentFocus].click();
        } else if (e.key === 'Escape') {
            autocompleteResults.classList.remove('show');
        }
    });
    
    function setActive(items) {
        items.forEach(item => item.classList.remove('active'));
        if (currentFocus >= items.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = items.length - 1;
        if (items[currentFocus]) items[currentFocus].classList.add('active');
    }
    
    // Fermer l'auto-complétion si clic ailleurs
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !autocompleteResults.contains(e.target)) {
            autocompleteResults.classList.remove('show');
        }
    });

    // Fonction pour rechercher un livre par ISBN ou titre (Google Books + fallback Open Library)
    async function searchBook(query) {
        // Essayer d'abord Google Books
        try {
            let apiUrl;
            
            if (isISBN(query)) {
                const cleanedISBN = cleanISBN(query);
                apiUrl = `https://www.googleapis.com/books/v1/volumes?q=isbn:${cleanedISBN}&langRestrict=fr`;
            } else {
                const encodedTitle = encodeURIComponent(query);
                apiUrl = `https://www.googleapis.com/books/v1/volumes?q=intitle:${encodedTitle}&langRestrict=fr&orderBy=relevance`;
            }
            
            const response = await fetch(apiUrl);
            
            if (response.ok) {
                const data = await response.json();
                if (data.items && data.totalItems > 0) {
                    return { source: 'google', data: data.items[0].volumeInfo };
                }
            }
        } catch (error) {
            console.error('Google Books error:', error);
        }
        
        // Fallback: Open Library via notre API
        try {
            if (isISBN(query)) {
                const response = await fetch(`/api/books/isbn/${cleanISBN(query)}`);
                const data = await response.json();
                if (data.success) {
                    return { source: 'openlibrary', data: data.book };
                }
            } else {
                const response = await fetch(`/api/books/search?q=${encodeURIComponent(query)}&limit=1`);
                const data = await response.json();
                if (data.success && data.books.length > 0) {
                    return { source: 'openlibrary', data: data.books[0] };
                }
            }
        } catch (error) {
            console.error('Open Library error:', error);
        }
        
        throw new Error('Aucun livre trouvé');
    }

    // Fonction pour remplir le formulaire
    function fillForm(result) {
        const bookInfo = result.data;
        const source = result.source;
        
        if (source === 'google') {
            // Format Google Books
            if (bookInfo.title) document.getElementById('title').value = bookInfo.title;
            if (bookInfo.authors?.length > 0) document.getElementById('author').value = bookInfo.authors.join(', ');
            if (bookInfo.description) document.getElementById('description').value = bookInfo.description;
            if (bookInfo.publisher) document.getElementById('publisher').value = bookInfo.publisher;
            if (bookInfo.publishedDate) document.getElementById('publication_year').value = bookInfo.publishedDate.split('-')[0];
            if (bookInfo.pageCount) document.getElementById('pages_count').value = bookInfo.pageCount;
            if (bookInfo.categories?.length > 0) document.getElementById('genre').value = bookInfo.categories[0];
            if (bookInfo.industryIdentifiers) {
                const isbn13 = bookInfo.industryIdentifiers.find(id => id.type === 'ISBN_13');
                const isbn10 = bookInfo.industryIdentifiers.find(id => id.type === 'ISBN_10');
                if (isbn13 || isbn10) document.getElementById('isbn').value = (isbn13 || isbn10).identifier;
            }
        } else {
            // Format Open Library
            if (bookInfo.title) document.getElementById('title').value = bookInfo.title;
            if (bookInfo.author) document.getElementById('author').value = bookInfo.author;
            if (bookInfo.year) document.getElementById('publication_year').value = bookInfo.year;
            if (bookInfo.pages) document.getElementById('pages_count').value = bookInfo.pages;
            if (bookInfo.isbn) document.getElementById('isbn').value = bookInfo.isbn;
            if (bookInfo.subjects?.length > 0) document.getElementById('genre').value = bookInfo.subjects[0];
            if (bookInfo.publishers?.length > 0) document.getElementById('publisher').value = bookInfo.publishers[0];
        }
    }

    // Gestionnaire de clic sur le bouton de recherche
    searchBtn.addEventListener('click', async function() {
        const query = searchInput.value.trim();
        
        if (!query) {
            alert('Veuillez saisir un ISBN ou un titre de livre');
            return;
        }

        // Masquer les messages précédents
        searchResult.style.display = 'none';
        searchError.style.display = 'none';
        searchLoading.style.display = 'block';
        autocompleteResults.classList.remove('show');

        try {
            const result = await searchBook(query);
            fillForm(result);
            searchLoading.style.display = 'none';
            searchResult.style.display = 'block';
        } catch (error) {
            searchLoading.style.display = 'none';
            searchError.style.display = 'block';
        }
    });

    // Permettre la recherche en appuyant sur Entrée (sauf si dans autocomplete)
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && currentFocus === -1) {
            e.preventDefault();
            searchBtn.click();
        }
    });
    
    // Compteur de caractères pour la description
    const descField = document.getElementById('description');
    const descCounter = document.getElementById('desc-counter');
    
    function updateDescCounter() {
        if (descField && descCounter) {
            descCounter.textContent = descField.value.length;
        }
    }
    
    if (descField) {
        descField.addEventListener('input', updateDescCounter);
        updateDescCounter();
    }
});
</script>

{% endblock %}
