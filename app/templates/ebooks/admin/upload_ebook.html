{% extends "base.html" %}

{% block title %}Uploader un Ebook - BiblioRuche{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('ebooks.admin_ebooks') }}">Administration Ebooks</a></li>
        <li class="breadcrumb-item active">Uploader</li>
    </ol>
</nav>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0"><i class="fas fa-upload"></i> Uploader un nouvel ebook</h4>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    <!-- Fichier EPUB obligatoire -->
                    <div class="mb-4">
                        <label for="epub_file" class="form-label">
                            <i class="fas fa-file-alt text-primary"></i> Fichier EPUB <span class="text-danger">*</span>
                        </label>
                        <input type="file" name="epub_file" id="epub_file" class="form-control" accept=".epub" required>
                        <div class="form-text">
                            Formats acceptés : .epub uniquement. Taille max : 50 MB
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- Informations du livre -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="title" class="form-label">Titre <span class="text-danger">*</span></label>
                            <input type="text" name="title" id="title" class="form-control" required maxlength="200">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="author" class="form-label">Auteur <span class="text-danger">*</span></label>
                            <input type="text" name="author" id="author" class="form-control" required maxlength="200">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea name="description" id="description" class="form-control" rows="4" maxlength="2000"></textarea>
                        <div class="form-text"><span id="desc-counter">0</span>/2000 caractères</div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="genre" class="form-label">Genre</label>
                            <input type="text" name="genre" id="genre" class="form-control" maxlength="100" list="genres-list">
                            <datalist id="genres-list">
                                <option value="Roman">
                                <option value="Science-Fiction">
                                <option value="Fantasy">
                                <option value="Thriller">
                                <option value="Policier">
                                <option value="Romance">
                                <option value="Horreur">
                                <option value="Biographie">
                                <option value="Histoire">
                                <option value="Essai">
                                <option value="Poésie">
                                <option value="Jeunesse">
                            </datalist>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="publication_year" class="form-label">Année de publication</label>
                            <input type="number" name="publication_year" id="publication_year" class="form-control" min="1800" max="2100">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="pages_count" class="form-label">Nombre de pages</label>
                            <input type="number" name="pages_count" id="pages_count" class="form-control" min="1">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="isbn" class="form-label">ISBN</label>
                        <input type="text" name="isbn" id="isbn" class="form-control" maxlength="20">
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- Image de couverture -->
                    <div class="mb-4">
                        <label for="cover_file" class="form-label">
                            <i class="fas fa-image text-info"></i> Image de couverture (optionnel)
                        </label>
                        <input type="file" name="cover_file" id="cover_file" class="form-control" accept="image/*">
                        <div class="form-text">
                            Formats acceptés : PNG, JPG, GIF, WEBP. Taille max : 5 MB
                        </div>
                    </div>
                    
                    <!-- Liaison avec un livre existant -->
                    <div class="mb-4">
                        <label for="book_proposal_id" class="form-label">
                            <i class="fas fa-link text-warning"></i> Lier à un livre existant (optionnel)
                        </label>
                        <select name="book_proposal_id" id="book_proposal_id" class="form-select">
                            <option value="">-- Aucune liaison --</option>
                            {% for book in available_books %}
                            <option value="{{ book.id }}" 
                                    data-title="{{ book.title }}"
                                    data-author="{{ book.author }}"
                                    data-description="{{ book.description or '' }}"
                                    data-genre="{{ book.genre or '' }}"
                                    data-isbn="{{ book.isbn or '' }}"
                                    data-year="{{ book.publication_year or '' }}"
                                    data-pages="{{ book.pages_count or '' }}">
                                {{ book.title }} - {{ book.author }}
                                {% if book.status == 'reading' %}(En lecture){% endif %}
                                {% if book.status == 'completed' %}(Terminé){% endif %}
                                {% if book.status == 'archived' %}(Archivé){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            <i class="fas fa-magic text-success"></i> 
                            Sélectionner un livre remplira automatiquement les informations ci-dessus
                        </div>
                    </div>
                    
                    <!-- Visibilité -->
                    <div class="mb-4">
                        <div class="form-check">
                            <input type="checkbox" name="is_visible" id="is_visible" class="form-check-input" checked>
                            <label for="is_visible" class="form-check-label">
                                <i class="fas fa-eye"></i> Rendre visible immédiatement
                            </label>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-upload"></i> Uploader l'ebook
                        </button>
                        <a href="{{ url_for('ebooks.admin_ebooks') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Annuler
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Compteur de caractères pour la description
document.getElementById('description').addEventListener('input', function() {
    document.getElementById('desc-counter').textContent = this.value.length;
});

// Auto-remplissage quand on sélectionne un livre
document.getElementById('book_proposal_id').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    
    if (this.value === '') {
        // Aucune sélection, on ne fait rien
        return;
    }
    
    // Récupérer les données depuis les attributs data-*
    const title = selectedOption.dataset.title || '';
    const author = selectedOption.dataset.author || '';
    const description = selectedOption.dataset.description || '';
    const genre = selectedOption.dataset.genre || '';
    const isbn = selectedOption.dataset.isbn || '';
    const year = selectedOption.dataset.year || '';
    const pages = selectedOption.dataset.pages || '';
    
    // Demander confirmation si des champs sont déjà remplis
    const titleField = document.getElementById('title');
    const authorField = document.getElementById('author');
    
    if (titleField.value || authorField.value) {
        if (!confirm('Voulez-vous écraser les informations actuelles avec celles du livre sélectionné ?')) {
            return;
        }
    }
    
    // Remplir les champs
    titleField.value = title;
    authorField.value = author;
    document.getElementById('description').value = description;
    document.getElementById('desc-counter').textContent = description.length;
    document.getElementById('genre').value = genre;
    document.getElementById('isbn').value = isbn;
    document.getElementById('publication_year').value = year;
    document.getElementById('pages_count').value = pages;
    
    // Notification visuelle
    const flash = document.createElement('div');
    flash.className = 'alert alert-success alert-dismissible fade show mt-3';
    flash.innerHTML = `
        <i class="fas fa-check-circle"></i> Informations du livre "<strong>${title}</strong>" importées !
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    this.parentNode.appendChild(flash);
    
    // Supprimer l'alerte après 3 secondes
    setTimeout(() => flash.remove(), 3000);
});
</script>
{% endblock %}
