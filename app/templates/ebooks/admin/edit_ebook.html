{% extends "base.html" %}

{% block title %}Modifier {{ ebook.title }} - BiblioRuche{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('ebooks.admin_ebooks') }}">Administration Ebooks</a></li>
        <li class="breadcrumb-item active">Modifier</li>
    </ol>
</nav>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-edit"></i> Modifier l'ebook</h4>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    <!-- Informations du fichier actuel -->
                    <div class="alert alert-info mb-4">
                        <strong><i class="fas fa-file"></i> Fichier actuel :</strong> {{ ebook.original_filename }}
                        <br>
                        <small class="text-muted">
                            Taille : {{ ebook.get_file_size_display() }} | 
                            Téléchargements : {{ ebook.download_count }}
                        </small>
                    </div>
                    
                    <!-- Informations du livre -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="title" class="form-label">Titre <span class="text-danger">*</span></label>
                            <input type="text" name="title" id="title" class="form-control" value="{{ ebook.title }}" required maxlength="200">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="author" class="form-label">Auteur <span class="text-danger">*</span></label>
                            <input type="text" name="author" id="author" class="form-control" value="{{ ebook.author }}" required maxlength="200">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea name="description" id="description" class="form-control" rows="4" maxlength="2000">{{ ebook.description or '' }}</textarea>
                        <div class="form-text"><span id="desc-counter">{{ (ebook.description or '')|length }}</span>/2000 caractères</div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="genre" class="form-label">Genre</label>
                            <input type="text" name="genre" id="genre" class="form-control" value="{{ ebook.genre or '' }}" maxlength="100" list="genres-list">
                            <datalist id="genres-list">
                                <option value="Roman">
                                <option value="Science-Fiction">
                                <option value="Fantasy">
                                <option value="Thriller">
                                <option value="Policier">
                                <option value="Romance">
                                <option value="Horreur">
                                <option value="Biographie">
                                <option value="Histoire">
                                <option value="Essai">
                                <option value="Poésie">
                                <option value="Jeunesse">
                            </datalist>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="publication_year" class="form-label">Année de publication</label>
                            <input type="number" name="publication_year" id="publication_year" class="form-control" value="{{ ebook.publication_year or '' }}" min="1800" max="2100">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="pages_count" class="form-label">Nombre de pages</label>
                            <input type="number" name="pages_count" id="pages_count" class="form-control" value="{{ ebook.pages_count or '' }}" min="1">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="isbn" class="form-label">ISBN</label>
                        <input type="text" name="isbn" id="isbn" class="form-control" value="{{ ebook.isbn or '' }}" maxlength="20">
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- Image de couverture -->
                    <div class="mb-4">
                        <label for="cover_file" class="form-label">
                            <i class="fas fa-image text-info"></i> Nouvelle image de couverture (optionnel)
                        </label>
                        {% if ebook.cover_filename %}
                        <div class="mb-2">
                            <img src="{{ url_for('ebooks.get_cover', ebook_id=ebook.id) }}" alt="Couverture actuelle" class="img-thumbnail" style="max-height: 150px;">
                            <small class="d-block text-muted">Couverture actuelle</small>
                        </div>
                        {% endif %}
                        <input type="file" name="cover_file" id="cover_file" class="form-control" accept="image/*">
                        <div class="form-text">
                            Laissez vide pour conserver la couverture actuelle. Formats : PNG, JPG, GIF, WEBP
                        </div>
                    </div>
                    
                    <!-- Liaison avec un livre existant -->
                    <div class="mb-4">
                        <label for="book_proposal_id" class="form-label">
                            <i class="fas fa-link text-warning"></i> Lier à un livre existant (optionnel)
                        </label>
                        <select name="book_proposal_id" id="book_proposal_id" class="form-select">
                            <option value="">-- Aucune liaison --</option>
                            {% for book in available_books %}
                            <option value="{{ book.id }}" 
                                    {% if ebook.book_proposal_id == book.id %}selected{% endif %}
                                    data-title="{{ book.title }}"
                                    data-author="{{ book.author }}"
                                    data-description="{{ book.description or '' }}"
                                    data-genre="{{ book.genre or '' }}"
                                    data-isbn="{{ book.isbn or '' }}"
                                    data-year="{{ book.publication_year or '' }}"
                                    data-pages="{{ book.pages_count or '' }}">
                                {{ book.title }} - {{ book.author }}
                                {% if book.status == 'reading' %}(En lecture){% endif %}
                                {% if book.status == 'completed' %}(Terminé){% endif %}
                                {% if book.status == 'archived' %}(Archivé){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            <i class="fas fa-magic text-success"></i> 
                            Changer de livre peut importer ses informations (après confirmation)
                        </div>
                    </div>
                    
                    <!-- Visibilité -->
                    <div class="mb-4">
                        <div class="form-check">
                            <input type="checkbox" name="is_visible" id="is_visible" class="form-check-input" {% if ebook.is_visible %}checked{% endif %}>
                            <label for="is_visible" class="form-check-label">
                                <i class="fas fa-eye"></i> Ebook visible
                            </label>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save"></i> Enregistrer les modifications
                        </button>
                        <a href="{{ url_for('ebooks.admin_ebooks') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Annuler
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Compteur de caractères
document.getElementById('description').addEventListener('input', function() {
    document.getElementById('desc-counter').textContent = this.value.length;
});

// Auto-remplissage quand on change de livre lié
document.getElementById('book_proposal_id').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    
    if (this.value === '') {
        return;
    }
    
    // Demander confirmation avant d'écraser
    if (!confirm('Voulez-vous importer les informations du livre sélectionné ? Cela écrasera les données actuelles.')) {
        return;
    }
    
    // Récupérer les données depuis les attributs data-*
    document.getElementById('title').value = selectedOption.dataset.title || '';
    document.getElementById('author').value = selectedOption.dataset.author || '';
    document.getElementById('description').value = selectedOption.dataset.description || '';
    document.getElementById('desc-counter').textContent = (selectedOption.dataset.description || '').length;
    document.getElementById('genre').value = selectedOption.dataset.genre || '';
    document.getElementById('isbn').value = selectedOption.dataset.isbn || '';
    document.getElementById('publication_year').value = selectedOption.dataset.year || '';
    document.getElementById('pages_count').value = selectedOption.dataset.pages || '';
    
    // Notification visuelle
    const flash = document.createElement('div');
    flash.className = 'alert alert-success alert-dismissible fade show mt-3';
    flash.innerHTML = `
        <i class="fas fa-check-circle"></i> Informations importées depuis "<strong>${selectedOption.dataset.title}</strong>"
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    this.parentNode.appendChild(flash);
    setTimeout(() => flash.remove(), 3000);
});
</script>
{% endblock %}
